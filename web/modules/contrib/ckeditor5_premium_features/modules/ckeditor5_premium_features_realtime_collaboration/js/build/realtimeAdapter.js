/*!
 * Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 * For licensing, see https://ckeditor.com/legal/ckeditor-oss-license
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.CKEditor5=e():(t.CKEditor5=t.CKEditor5||{},t.CKEditor5.realtimeAdapter=e())}(self,(()=>(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>s});const i=class{constructor(t){this.editor=t,this.elementId=null,void 0!==this.editor.sourceElement&&(this.elementId=this.editor.sourceElement.dataset.ckeditor5PremiumElementId)}processCollaborationCommandDisable(t){if(!this.isCollaborationDisabled())return!1;const e=this.editor.commands._commands.get(t);return void 0===e||e.forceDisabled("premium-features-module"),!0}processRevisionDisable(){return!!this.isCollaborationDisabled()&&(this.editor.plugins.has("RevisionTracker")&&(this.editor.plugins.get("RevisionTracker").isEnabled=!1),!0)}isCollaborationDisabled(){return void 0!==drupalSettings.ckeditor5Premium&&void 0!==drupalSettings.ckeditor5Premium.disableCollaboration&&!0===drupalSettings.ckeditor5Premium.disableCollaboration}getEditorParentContainer(t){let e=document.getElementById(t);for(;e&&void 0!==e&&void 0!==e.classList&&!e.classList.contains("ck-editor-container");)e=e.parentElement;return e&&void 0!==e?e.parentElement:null}getSourceDataSelector(t){return{trackChanges:".track-changes",comments:".comments",revisionHistory:".revision-history",revisionHistoryContainer:".revision-history-container",resolvedSuggestionsComments:".resolved-suggestions-comments"}[t]+"-data"+`[data-ckeditor5-premium-element-id="${this.elementId}"]`}};const s={RealtimeAdapter:class{constructor(t){this.editor=t,this.submitElements=[],this.formElement=this.editor.sourceElement.closest("form"),this.disabledAttributeName="data-ckeditor5-block-"+this.editor.id,void 0!==this.editor.sourceElement&&(this.storage=new i(t),void 0!==drupalSettings.ckeditor5ChannelId&&void 0!==this.editor.sourceElement.dataset.ckeditorfieldid&&void 0!==drupalSettings.ckeditor5ChannelId[this.editor.sourceElement.dataset.ckeditorfieldid]&&(this.editor.config._config.collaboration={channelId:drupalSettings.ckeditor5ChannelId[this.editor.sourceElement.dataset.ckeditorfieldid]},this.setPresenceListContainer(),this.disableSubmitButtons()))}static get pluginName(){return"RealtimeAdapter"}init(){if(void 0===this.editor.sourceElement)return;const t=this.editor,e=t.plugins.has("RealTimeCollaborativeEditing"),i=t.plugins.has("SourceEditing")||t.plugins.has("SourceEditingEnhanced");e&&i&&(console.info("The Source editing plugin is not compatible with real-time collaboration, so it has been disabled. If you need it, please contact us to discuss your use case - https://ckeditor.com/contact/"),t.plugins.has("SourceEditing")&&t.plugins.get("SourceEditing").forceDisabled("drupal-rtc"),t.plugins.has("SourceEditingAdvanced")&&t.plugins.get("SourceEditingAdvanced").forceDisabled("drupal-rtc"));let s=this.getFieldWrapper(this.editor.sourceElement.id);s&&(this.textFormatSelect=s.querySelector(".js-filter-list"),this.textFormatSelect&&this.textFormatSelect.addEventListener("change",this.changeEditor.bind(this)))}getFieldWrapper(t){const e=document.getElementById(t);return e?e.closest(".js-text-format-wrapper"):null}changeEditor(t){const e=this.editor.config._config.collaboration.channelId,i=new XMLHttpRequest,s="/ckeditor5-premium-features-realtime-collaboration/flush-session/"+e;i.open("DELETE",s),i.send()}setPresenceListContainer(){const t=this.editor.config._config.presenceList;if(t&&void 0!==t){if(!t.container){const e=this.editor.sourceElement.id+"-presence-list-container",i=document.getElementById(e);if(i)t.container=i;else{const i=this.editor.sourceElement.closest(".form-item"),s=document.createElement("div");s.setAttribute("class","ck-presence-list-container"),s.setAttribute("id",e),i.parentNode.insertBefore(s,i.previousSibling),t.container=s}}t.collapseAt||(t.collapseAt=drupalSettings.presenceListCollapseAt)}}clearPresenceListContainer(){const t=this.editor.config._config.presenceList.container;t&&(t.innerHTML="")}afterInit(){if(void 0!==this.editor.sourceElement){if(this.storage.processCollaborationCommandDisable("trackChanges"),this.storage.processCollaborationCommandDisable("addCommentThread"),this.checkIfInitialDataChanged(),drupalSettings.ckeditor5Premium.notificationsEnabled){this.editor.sourceElement.closest("form").addEventListener("submit",(()=>{const t=this.editor.plugins.has("CommentsRepository"),e=this.editor.plugins.has("TrackChanges"),i=this.editor.plugins.has("RealtimeCommentNotifications");if(!t||!e)return;const s=".track-changes",o=".comments",r=`[data-ckeditor5-premium-element-id="${this.editor.sourceElement.dataset.ckeditor5PremiumElementId}"]`;if(e){let t=new Map;const e=s+"-data",i=this.editor.plugins.get("TrackChanges").getSuggestions({skipNotAttached:!1}),o=document.querySelector(e+r);for(let e in i){let s=this.cloneSuggestionForBackend(i[e]);null==i[e].head||null==i[e].next&&null==i[e].previous||(s.attributes.head=i[e].head),s.attributes.items=i[e].getItems(),t.set(i[e].id,i[e])}o.value=JSON.stringify(Array.from(t.values()))}if(t&&!i){const t=o+"-data",e=this.editor.plugins.get("CommentsRepository");document.querySelector(t+r).value=JSON.stringify(e.getCommentThreads({skipNotAttached:!0,skipEmpty:!0,toJSON:!0}))}}))}this.editor.on("ready",(()=>{let t=this.editor.sourceElement.dataset.editorActiveTextFormat,e=drupalSettings.ckeditor5Premium.tracking_changes.default_state;void 0!==e[t]&&e[t]&&this.editor.execute("trackChanges"),this.enableSubmitButtons()}))}}destroy(){(this.textFormatSelect||void 0!==this.textFormatSelect)&&this.textFormatSelect.removeEventListener("change",this.changeEditor.bind(this)),this.clearPresenceListContainer(),this.submitElements=[]}checkIfInitialDataChanged(){const t=this.editor.config._config.initialData;this.editor.on("ready",(()=>{t!==this.editor.getData()&&this.editor.sourceElement.setAttribute("data-editor-value-is-changed",!0)}))}disableSubmitButtons(){this.formElement&&(this.submitElements=this.formElement.querySelectorAll('input[type="submit"], button[type="submit"]'),Array.from(this.submitElements).forEach((t=>{t.disabled=!0,t.setAttribute(this.disabledAttributeName,!0)})))}enableSubmitButtons(){this.formElement&&Array.from(this.submitElements).forEach((t=>{t.removeAttribute(this.disabledAttributeName),this.hasDataBlockedAttribute(t)||(t.disabled=!1)}))}hasDataBlockedAttribute(t){if(!t||!t.hasAttributes())return!1;for(let e of t.attributes)if(e.name.startsWith("data-ckeditor5-block-"))return!0;return!1}cloneSuggestionForBackend(t){return{id:t.id,type:t.type,authorId:t.authorId,createdAt:t.createdAt,hasComments:t.hasComments,data:t.data,attributes:t.attributes}}}};return e=e.default})()));